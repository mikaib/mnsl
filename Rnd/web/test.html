<!DOCTYPE html>
<html>
<head>
    <title>SPIRV Processor</title>
</head>
<body>
<h1>SPIRV Processor</h1>
<input type="file" id="fileInput" accept=".spv" />
<button onclick="testProcessor()">Test Processor</button>
<pre id="output"></pre>

<iframe id="worker-template" style="display: none;" srcdoc='
        <!DOCTYPE html>
        <html>
        <head><title>SPIRV Worker</title></head>
        <body>
            <script src="./spirv-dis.js"></script>
            <script>
                window.addEventListener("message", function(event) {
                    if (event.data.type === "PROCESS_SPIRV") {
                        const binaryData = new Uint8Array(event.data.data);

                        try {
                            const inputPath = "/input.spv";
                            Module.FS.writeFile(inputPath, binaryData);

                            let output = "";

                            let result;
                            if (Module.callMain) {
                                result = Module.callMain([inputPath, "-o", "/tmp/output.spvasm"]);
                            } else if (Module.main) {
                                result = Module.main(4, ["spirv-dis", inputPath, "-o", "/tmp/output.spvasm"]);
                            }

                            if (result !== 0) {
                                throw new Error("SPIRV disassembly failed with exit code " + result);
                            }

                            try {
                                Module.FS.unlink(inputPath);
                            } catch (e) {}

                            // List files
                            var files = Module.FS.readdir("/");
                            console.log("Files in FS:", files);
                            var outputPath = "/tmp/output.spvasm";
                            try {
                                output = Module.FS.readFile(outputPath, { encoding: "utf8" });
                                Module.FS.unlink(outputPath);
                            } catch (e) {
                                throw new Error("Failed to read output file: " + e.message);
                            }

                            parent.postMessage({
                                type: "SPIRV_RESULT",
                                success: true,
                                exitCode: result,
                                output: output,
                            }, "*");

                        } catch (error) {
                            parent.postMessage({
                                type: "SPIRV_RESULT",
                                success: false,
                                error: error.message
                            }, "*");
                        }
                    }
                });

                Module.onRuntimeInitialized = function() {
                    parent.postMessage({type: "SPIRV_READY"}, "*");
                };
            </script>
        </body>
        </html>
    '></iframe>

<script>
    async function processSpirvBinary(binaryData, options = {}) {
        const { timeout = 10000, args = [] } = options;

        return new Promise((resolve, reject) => {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.srcdoc = document.getElementById('worker-template').srcdoc;

            let isResolved = false;
            const timeoutId = setTimeout(() => {
                if (!isResolved) {
                    isResolved = true;
                    cleanup();
                    reject(new Error('Processing timeout'));
                }
            }, timeout);

            function cleanup() {
                clearTimeout(timeoutId);
                window.removeEventListener('message', messageHandler);
                if (iframe.parentNode) {
                    iframe.remove();
                }
            }

            function messageHandler(event) {
                if (event.source !== iframe.contentWindow) return;

                if (event.data.type === 'SPIRV_READY') {
                    iframe.contentWindow.postMessage({
                        type: 'PROCESS_SPIRV',
                        data: Array.from(binaryData),
                        args: args
                    }, '*');

                } else if (event.data.type === 'SPIRV_RESULT') {
                    if (!isResolved) {
                        isResolved = true;
                        cleanup();

                        if (event.data.success) {
                            resolve({
                                success: true,
                                exitCode: event.data.exitCode,
                                output: event.data.output,
                                error: event.data.error
                            });
                        } else {
                            resolve({
                                success: false,
                                error: event.data.error
                            });
                        }
                    }
                }
            }

            window.addEventListener('message', messageHandler);
            document.body.appendChild(iframe);
        });
    }

    async function processSpirvFile(file, options = {}) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const binaryData = new Uint8Array(e.target.result);
                    const result = await processSpirvBinary(binaryData, options);
                    resolve(result);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsArrayBuffer(file);
        });
    }

    async function testProcessor() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            alert('Please select a .spv file');
            return;
        }

        document.getElementById('output').textContent = 'Processing...';

        try {
            const result = await processSpirvFile(file, {
                timeout: 15000,
                args: []
            });

            if (result.success) {
                document.getElementById('output').textContent =
                    `Success! Exit code: ${result.exitCode}\n\nOutput:\n${result.output}${result.error}`;
            } else {
                document.getElementById('output').textContent = 'Error: ' + result.error;
            }

        } catch (error) {
            document.getElementById('output').textContent = 'Processing failed: ' + error.message;
        }
    }

    async function exampleUsage() {
        try {
            const result = await processSpirvBinary(spirvData, {
                timeout: 10000,
                args: ['--no-color']
            });

            if (result.success) {
                console.log('SPIRV disassembly:', result.output);
            } else {
                console.error('Processing failed:', result.error);
            }
        } catch (error) {
            console.error('Error:', error.message);
        }
    }

    window.processSpirvBinary = processSpirvBinary;
    window.processSpirvFile = processSpirvFile;
</script>
</body>
</html>